# Введение в SQL

Знакомство со средой pgAdmin и написание SQL-запросов с использованием оператора SELECT. Для модельной базы данных были составлены 4 SELECT-запроса, решающие полезные задачи из предметной области. Скрипт для создания и заполнения модельной базы данных и её описание:
https://postgrespro.ru/education/demodb

# Создание БД для приложения

## 1.Проектирование схемы базы данных

Проектирование схемы базы данных для работы приложения (WEB/Mobile/Desktop). Предметная область - Домоуправление. База данных будет использована для контроля за оплатой коммунальных услуг и заменой счётчиков. Результат - схема базы данных (в виде ER-диаграммы, содержащей таблицы и связи между ними, без уточнения типов столбцов). Для проектирования схемы и построения диаграммы использовался:
https://www.lucidchart.com/pages/examples/er-diagram-tool

## 2.Создание и заполнение таблиц

Подготовка SQL-скрипта для создания таблиц согласно схеме, составленной на предыдущем этапе (с уточнением типов столбцов). Были определены первичные и внешние ключи, а также декларативные ограничения целостности (возможность принимать неопределенное значение, уникальные ключи, проверочные ограничения и т. д.). Кроме того, были подготовлены данные для заполнения созданных таблиц. На основе этих данных были созданы SQL-скрипт для вставки соответствующих строк в таблицы БД.

## 3.Операторы манипулирования

Манипулирование данными с помощью операторов SQL. В ходе выполнения были сделано:

    • 5 выборок, которые имеют осмысленное значение для предметной области, и также составлены для них SQL-скрипты.

    • 4 запроса на изменение и удаление из базы данных, и также составленыдля них SQL-скрипты.

## 4.Контроль целостности данных

Контроль целостности данных производится с помощью механизма транзакций и триггеров. Транзакции позволяют рассматривать группу операций как единое целое, либо отрабатывают все операции, либо ни одной. Это позволяет избегать несогласованности данных. Триггеры позволяют проверять целостность
данных в момент выполнения транзакций, поддерживать целостность, внося изменения, и откатывать транзакции, приводящие к потере целостности. Подготовлены SQL-скрипты для проверки наличия аномалий (потерянных изменений, грязных чтений, неповторяющихся чтений, фантомов) при параллельном исполнении транзакций на различных уровнях изолированности SQL/92 (READ UNCOMMITTED, READ COMMITTED, REPEATABLE READ, SERIALIZABLE). Для проверки наличия аномалий используются два параллельных сеанса, операторы в которых выполняются пошагово:

    • Установлен в обоих сеансах уровень изоляции READ UNCOMMITTED. Выполняются сценарии проверки наличия аномалий потерянных изменений и грязных чтений.
    
    • Установлен в обоих сеансах уровень изоляции READ COMMITTED. Выполняются сценарии проверки наличия аномалий грязных чтений и неповторяющихся чтений.
    
    • Установлен в обоих сеансах уровень изоляции REPEATABLE READ. Выполняются сценарии проверки наличия аномалий неповторяющихся чтений и фантомов.
    
    • Установлен в обоих сеансах уровень изоляции SERIALIZABLE. Выполняется сценарий проверки наличия фантомов.
    
Составлены скрипты для создания триггеров, а также подготовлены несколько запросов для проверки и демонстрации их полезных свойств:

    • Изменение данных для сохранения целостности.
    
    • Проверка транзакций и их откат в случае нарушения целостности.

# Создание БД для аналитики

## 1.Проектирование схемы базы данных

Исходим из того, что приложение, для которого была сделана база данных в прошлой работе, стало очень популярным и по нему каждый день можно собирать большой объем статистической информации. Были составлены: схема базы данных, скрипты создания базы данных и ее заполнения, обладающие следующими свойствами:

    • Одна таблица содержит 100 млн. записей(Payment), которые со временем теряют актуальность.
    
    • Другие таблицы, связанные с первой, содержат по 1 млн. записей(Housing, Service).
    
    • В одной из таблиц с количество записей 1 млн.(Housing) есть колонка с текстом, по которой будет настроен полнотекстовый поиск.
    
    • В одной из таблиц с количество записей больше 1 млн.(Housing) есть колонка с данными в json-формате.
    
    • В одной из таблиц с количество записей больше 1 млн.(Housing) есть колонка с массивом.
    
При проектировании учитывались плюсы и минусы денормализации схемы данных и использования массивов и json-формата.
Для проектирования схемы и построения диаграммы использовался сайт:
https://www.lucidchart.com/pages/examples/er-diagram-tool

## 2.Управление доступом

Цель - освоение работы с представлениями и другими способами управления доступом. Было сделано:

    • Создан пользователь test и выдан ему доступ к базе данных.
    
    • Составлены и выполнены скрипты присвоения новому пользователю прав доступа к таблицам. При этом права доступа к различным таблицам различны, а именно:
    
        ◦ Для одной таблицы(Payment) новому пользователю присвоены права SELECT, INSERT, UPDATE в полном объеме.
        
        ◦ Для одной таблицы(Housing) новому пользователю присвоены права SELECT и UPDATE только избранных столбцов(owner_details, tenants).
        
        ◦ Для одной таблицы(Service) новому пользователю присвоено только право SELECT.
        
    • Составлены SQL-скрипты для создания нескольких представлений, которые позволяют упростить манипуляции с данными или ограничить доступ к данным, предоставляя только необходимую информацию.
    
    • Присвоено новому пользователю право доступа (SELECT) к одному из представлений(AMOUNT_PAYMENT)
    
    • Создана стандартная роль уровня базы данных, присвоено ей право доступа (UPDATE на некоторые столбцы(date_entry)) к одному из представлений(PAYMENTS_USERS), назначена новому пользователю созданная роль.
    
    • Выполнены от имени нового пользователя некоторые выборки из таблиц и представлений. Права доступа корректны.
    
    • Выполнены от имени нового пользователя операторы изменения таблиц с ограниченными правами доступа.

## 3.Функции и язык PL/pgSQL

Упрощение работы аналитика с помощью создания и использования функций. Было сделано:

    • Составлены SQL-скрипты для создания нескольких функций, упрощающих манипуляции с данными.
    
    • В скриптах использовались:
    
        ◦ Циклы
        
        ◦ Ветвления
        
        ◦ Переменные
        
        ◦ Курсоры
        
        ◦ Исключения

## 4.Индексы

Ускорение выполнения запросов. Для этого использованы механизмы секционирования, наследования и индексов. Подготовлены два запроса:

    • Запрос к одной таблице, содержащий фильтрацию по нескольким полям.
    
    • Запрос к нескольким связанным таблицам, содержащий фильтрацию по нескольким полям.
    
Для каждого из этих запросов проведены следующие шаги:

    • Получен план выполнения запроса без использования индексов.
    
    • Получена статистика (IO и Time) выполнения запроса без использования индексов.
    
    • Созданы нужные индексы, позволяющие ускорить запрос.
    
    • Получен план выполнения запроса с использованием индексов. Видны изменения по сравнению с первоначальным планом.
    
    • Получена статистика выполнения запроса с использованием индексов. Она показала результаты лучше, чем первоначальная статистика.
    
Также продемонстрирована полезность индексов для организации полнотекстового поиска, фильтрации с использованием массива и json-формата.
Для таблицы объемом 100 млн. записей(Payment) произведена оптимизация, позволяющая быстро удалять старые данные, ускорить вставку и чтение данных.
